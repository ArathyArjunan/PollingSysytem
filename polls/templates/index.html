<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Polling App — Full UI (Login/Register/Logout/Active Polls/Vote/My Votes/Admin Chart)</title>

  <!-- Chart.js for admin pie chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --primary:#0b78ff;
      --accent:#6f42c1;
      --success:#17a673;
      --danger:#e04848;
      --muted:#6b7280;
      --light:#f3f5f8;
      --glass: rgba(255,255,255,0.7);
      --shadow: 0 6px 18px rgba(14,20,30,0.08);
      --radius:12px;
    }

    *{box-sizing:border-box}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg),#eef2f7);
      margin:0;
      color:#0f1724;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px 16px;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
      box-shadow:var(--shadow);
    }
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:8px;align-items:center}

    .container{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:var(--shadow);
    }

    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
    }

    /* left column */
    .panel{
      background:var(--card);
      border-radius:10px;
      padding:14px;
      border:1px solid #eef2f6;
    }
    .panel h3{margin:0 0 12px 0;font-size:15px;color:var(--primary)}
    input[type="text"], input[type="email"], input[type="password"], select{
      width:100%;
      padding:10px 12px;
      margin:8px 0 12px 0;
      border-radius:8px;border:1px solid #e6eef8;background:var(--light);
      font-size:14px;
    }
    button{
      padding:10px 12px;border-radius:8px;border:none;background:var(--primary);color:white;font-weight:600;
      cursor:pointer;
    }
    button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,120,255,0.12)}
    button.danger{background:var(--danger)}
    .muted{color:var(--muted);font-size:13px}

    /* main area (right) */
    .tabs{display:flex;gap:8px;border-bottom:1px solid #eef4fb;margin-bottom:12px;padding-bottom:8px}
    .tab{padding:8px 12px;border-radius:8px;cursor:pointer;color:var(--muted);font-weight:600}
    .tab.active{background:linear-gradient(90deg,var(--light),#fff);color:var(--primary);box-shadow:0 6px 18px rgba(11,120,255,0.06)}
    .poll-card{
      border-radius:12px;background:linear-gradient(180deg,#ffffff,#fbfdff);padding:14px;margin-bottom:12px;border:1px solid #eef6fb;
      box-shadow: 0 4px 12px rgba(6,14,30,0.03);
    }
    .poll-card h4{margin:0 0 6px 0}
    .poll-desc{color:var(--muted);font-size:13px;margin-bottom:8px}
    .question{margin-top:8px;padding:10px;border-radius:10px;background:var(--light)}
    .choice-row{display:flex;align-items:center;gap:10px;margin-top:8px}
    .choice-text{flex:1}
    .btn-choice{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;font-weight:600;cursor:pointer}
    .progress{height:22px;background:#f1f5f9;border-radius:10px;overflow:hidden;flex-basis:220px}
    .progress > .bar{height:100%;text-align:center;line-height:22px;color:white;font-weight:600}

    .vote-badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef6ff;color:var(--primary);font-weight:600;margin-left:8px;font-size:13px}

    .empty{padding:24px;text-align:center;color:var(--muted);border-radius:10px;background:linear-gradient(180deg,#fbfdff,#fff);border:1px dashed #e6eef8}

    /* my votes */
    .vote-card{border-left:4px solid var(--primary);padding:12px;border-radius:8px;margin-bottom:10px;background:#fff}
    .vote-meta{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:13px}

    /* admin */
    .admin-panel{margin-top:12px;padding:14px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef6fb}
    .small{font-size:13px;color:var(--muted)}
    
    /* admin controls */
    .admin-controls {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    
    /* vote results cards */
    .results-card {
      background: var(--light);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 4px solid var(--success);
    }
    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .results-stats {
      display: flex;
      gap: 15px;
      font-size: 13px;
      color: var(--muted);
    }

    /* responsive */
    @media (max-width:920px){
      .grid{grid-template-columns:1fr; }
      .panel{order:2}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo">PA</div>
        <div>
          <h1>Polling App</h1>
          <div class="small muted">Login / Register / Vote / Admin Chart</div>
        </div>
      </div>

      <div class="controls" id="top-controls">
        <!-- populated by JS -->
      </div>
    </div>

    <div class="container">
      <div class="grid">
        <!-- LEFT: Auth / Register / Quick Controls -->
        <div class="panel" id="left-panel">
          <div id="auth-forms">
            <!-- Login -->
            <div id="login-box">
              <h3>Login</h3>
              <input id="username" placeholder="Username" type="text" />
              <input id="password" placeholder="Password" type="password" />
              <button onclick="login()">Login</button>
              <div style="margin-top:10px">
                <a href="#" onclick="showRegister();return false;" class="muted">Create account</a>
              </div>
              <div id="login-msg" class="muted" style="margin-top:8px"></div>
            </div>

            <!-- Register -->
            <div id="register-box" style="display:none">
              <h3>Create Account</h3>
              <input id="reg-username" placeholder="Username" type="text" />
              <input id="reg-email" placeholder="Email" type="email" />
              <input id="reg-password" placeholder="Password" type="password" />
              <button onclick="registerUser()">Register</button>
              <div style="margin-top:10px">
                <a href="#" onclick="showLogin();return false;" class="muted">Back to login</a>
              </div>
              <div id="register-msg" class="muted" style="margin-top:8px"></div>
            </div>
          </div>

          <!-- Quick user area -->
          <div id="user-box" style="display:none;margin-top:12px">
            <h3 id="user-title">Hi, User</h3>
            <div class="small" id="user-email"></div>
            <div style="margin-top:12px">
              <button class="ghost" onclick="showTab('polls')">Active Polls</button>
              <button class="ghost" onclick="showTab('myvotes')">My Votes</button>
            </div>
            <div style="margin-top:12px">
              <button class="danger" onclick="logout()">Logout</button>
            </div>
          </div>

        </div>

        <!-- RIGHT: Main content -->
        <div>
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="display:flex;flex-direction:column">
                <div class="tabs" role="tablist">
                  <div id="tab-polls" class="tab active" onclick="showTab('polls')">Active Polls</div>
                  <div id="tab-myvotes" class="tab" onclick="showTab('myvotes')">My Votes</div>
                  <div id="tab-admin" class="tab" onclick="showTab('admin')" style="display:none">Admin Results</div>
                </div>
                <div class="small muted" id="status-line">Not logged in</div>
              </div>

              <div style="text-align:right">
                <div id="admin-badge" class="small" style="display:none;color:var(--accent);font-weight:700">SUPERADMIN</div>
              </div>
            </div>
          </div>

          <!-- Active Polls -->
          <div id="content-polls" style="margin-top:12px">
            <div id="poll-list"></div>
          </div>

          <!-- My Votes -->
          <div id="content-myvotes" style="display:none;margin-top:12px">
            <div id="my-votes-list"></div>
          </div>

          <!-- Admin: Poll results & chart -->
          <div id="content-admin" style="display:none;margin-top:12px">
            <div class="admin-panel">
              <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                <div style="flex:1">
                  <label class="small">Select poll to view full results</label>
                  <select id="admin-poll-select" onchange="adminLoadSelectedPollResults()"></select>
                </div>
                <div style="width:160px">
                  <label class="small">Refresh</label>
                  <div><button onclick="adminRefresh()">Refresh</button></div>
                </div>
              </div>
              
              <div class="admin-controls">
                <button onclick="adminExportCSV()">Export CSV</button>
                <button onclick="adminShowResults()">View Results</button>
              </div>

              <div style="margin-top:14px;display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap">
                <div style="flex:1;min-width:260px">
                  <canvas id="adminChart" style="max-height:360px"></canvas>
                </div>
                <div style="width:320px;min-width:240px">
                  <div class="small">Numeric Results</div>
                  <div id="admin-results-list" style="margin-top:8px"></div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div> <!-- grid -->
    </div> <!-- container -->
  </div> <!-- wrap -->

<script>
/* ========= Configuration ========= */
const API_BASE = "http://127.0.0.1:8000"; // <<-- set to your backend
let token = localStorage.getItem("token");
let currentUser = null;
let allPolls = [];
let myVotes = [];
let adminChart = null;

/* ======= Helpers ======= */
function setStatus(text){
  document.getElementById('status-line').innerText = text || '';
}
function showLogin(){ document.getElementById('login-box').style.display='block'; document.getElementById('register-box').style.display='none'; }
function showRegister(){ document.getElementById('login-box').style.display='none'; document.getElementById('register-box').style.display='block'; }
function showTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-polls').classList.toggle('active', tab==='polls');
  document.getElementById('tab-myvotes').classList.toggle('active', tab==='myvotes');
  document.getElementById('tab-admin').classList.toggle('active', tab==='admin');

  document.getElementById('content-polls').style.display = tab==='polls' ? 'block' : 'none';
  document.getElementById('content-myvotes').style.display = tab==='myvotes' ? 'block' : 'none';
  document.getElementById('content-admin').style.display = tab==='admin' ? 'block' : 'none';
}

/* ======= Auth actions ======= */
async function login(){
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  document.getElementById('login-msg').innerText = '';
  if(!username || !password){ document.getElementById('login-msg').innerText = 'Provide username and password'; return; }

  try{
    const res = await fetch(`${API_BASE}/token/`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if(res.ok && data.access){
      token = data.access;
      localStorage.setItem('token', token);
      await initializeAfterLogin();
    } else {
      document.getElementById('login-msg').innerText = data.detail || data.error || 'Login failed';
    }
  } catch(err){
    console.error(err);
    document.getElementById('login-msg').innerText = 'Network error';
  }
}

async function registerUser(){
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value.trim();
  document.getElementById('register-msg').innerText = '';
  if(!username || !email || !password){ document.getElementById('register-msg').innerText = 'All fields required'; return; }

  try{
    const res = await fetch(`${API_BASE}/register/`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, email, password })
    });
    const data = await res.json();
    if(res.ok){
      document.getElementById('register-msg').innerText = 'Registered — please login';
      document.getElementById('register-msg').style.color = 'green';
      showLogin();
    } else {
      document.getElementById('register-msg').innerText = data.error || JSON.stringify(data);
      document.getElementById('register-msg').style.color = 'crimson';
    }
  } catch(e){
    console.error(e);
    document.getElementById('register-msg').innerText = 'Network error';
  }
}

function logout(){
  localStorage.removeItem('token');
  token = null;
  currentUser = null;
  allPolls = [];
  myVotes = [];
  document.getElementById('user-box').style.display = 'none';
  document.getElementById('auth-forms').style.display = 'block';
  document.getElementById('tab-admin').style.display = 'none';
  document.getElementById('admin-badge').style.display = 'none';
  setStatus('Logged out');
  renderPollList(); renderMyVotes();
}

/* ======= Initialization after login ======= */
async function initializeAfterLogin(){
  // hide forms, show userbox
  document.getElementById('auth-forms').style.display = 'none';
  document.getElementById('user-box').style.display = 'block';

  await loadCurrentUser();
  await Promise.all([loadPolls(), loadMyVotes()]);
  renderPollList();
  renderMyVotes();
  setStatus(`Signed in as ${currentUser.username}`);
  
  // Show active results and voted cards after login
  showTab('polls');
  
  // admin UI
  if(currentUser.is_admin){
    document.getElementById('tab-admin').style.display = 'inline-block';
    document.getElementById('admin-badge').style.display = 'inline-block';
    await populateAdminPollSelect();
  } else {
    document.getElementById('tab-admin').style.display = 'none';
    document.getElementById('admin-badge').style.display = 'none';
  }
}

/* ======= Load current user ======= */
async function loadCurrentUser(){
  try{
    const res = await fetch(`${API_BASE}/current-user/`, { headers: authHeaders() });
    if(!res.ok) throw new Error('Not authorized');
    currentUser = await res.json();
    document.getElementById('user-title').innerText = `Hi, ${currentUser.username}`;
    document.getElementById('user-email').innerText = currentUser.email || '';
    // show top controls
    const top = document.getElementById('top-controls');
    top.innerHTML = `<div class="small muted">Signed in: <strong>${currentUser.username}</strong></div>`;
    top.innerHTML += ` <div style="margin-left:8px"><button onclick="logout()" class="ghost">Logout</button></div>`;
    document.getElementById('auth-forms').style.display = 'none';
  } catch(e){
    console.error(e);
    // fallback to show login
    document.getElementById('auth-forms').style.display = 'block';
    document.getElementById('user-box').style.display = 'none';
  }
}

/* ======= Polls ======= */
function authHeaders(){
  return token ? { 'Authorization': `Bearer ${token}` } : {};
}

async function loadPolls(){
  try{
    const res = await fetch(`${API_BASE}/polls/`, { headers: authHeaders() });
    if(!res.ok){
      allPolls = [];
      return;
    }
    allPolls = await res.json();
  } catch(e){
    console.error(e);
    allPolls = [];
  }
}

function renderPollList(){
  const list = document.getElementById('poll-list');
  list.innerHTML = '';
  if(!allPolls || allPolls.length===0){
    list.innerHTML = `<div class="empty">No polls available</div>`;
    return;
  }

  allPolls.forEach(poll=>{
    const pollDiv = document.createElement('div');
    pollDiv.className = 'poll-card';
    pollDiv.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
        <div>
          <h4>${escapeHtml(poll.title||'Untitled Poll')}</h4>
          <div class="poll-desc">${escapeHtml(poll.description || '')}</div>
        </div>
        <div class="small muted">Status: ${poll.is_active ? 'Active' : 'Closed'}</div>
      </div>
    `;

    // questions
    if(poll.questions && poll.questions.length>0){
      poll.questions.forEach(q=>{
        const qElem = document.createElement('div');
        qElem.className = 'question';
        let totalVotes = 0;
        if(q.choices && q.choices.length>0){
          totalVotes = q.choices.reduce((s,ch)=>s + (ch.vote_count||0), 0);
        }
        qElem.innerHTML = `<div style="font-weight:600">${escapeHtml(q.text||'Question')}</div>
                          <div class="small muted">Total votes: <span class="vote-badge">${totalVotes}</span></div>`;

        if(q.choices && q.choices.length>0){
          q.choices.forEach(choice=>{
            const choiceRow = document.createElement('div');
            choiceRow.className = 'choice-row';
            const votes = choice.vote_count || 0;
            const pct = totalVotes ? Math.round((votes/totalVotes)*100) : 0;
            // check if user voted this choice
            const votedChoiceIds = myVotes.map(v => v.choice_id || v.choice); // fallback
            const isMyVote = votedChoiceIds.includes(choice.id);

            choiceRow.innerHTML = `
              <div class="choice-text">${escapeHtml(choice.text || 'Choice')}</div>
              <div class="progress" title="${votes} votes">
                <div class="bar" style="width:${pct}%;background:${isMyVote?'var(--primary)':'var(--success)'}">${pct}%</div>
              </div>
              <div style="width:90px;text-align:right">
                <button class="btn-choice" ${poll.is_active ? '' : 'disabled'} onclick="vote(${poll.id}, ${q.id}, ${choice.id}, this)">
                  Vote
                </button>
              </div>
            `;
            qElem.appendChild(choiceRow);
          });
        } else {
          qElem.innerHTML += `<div class="muted" style="margin-top:8px">No choices available</div>`;
        }
        pollDiv.appendChild(qElem);
      });
    } else {
      pollDiv.innerHTML += `<div class="muted" style="margin-top:8px">No questions in this poll</div>`;
    }

    list.appendChild(pollDiv);
  });

}

/* ======= Vote action ======= */
async function vote(pollId, questionId, choiceId, btnRef){
  if(!token){ alert('You must login to vote'); return; }
  if(btnRef) btnRef.disabled = true;

  try{
    const res = await fetch(`${API_BASE}/polls/${pollId}/vote/`, {
      method:'POST',
      headers: Object.assign({ 'Content-Type': 'application/json' }, authHeaders()),
      body: JSON.stringify({ question: questionId, choice: choiceId })
    });
    if(res.ok){
      await loadMyVotes();
      await loadPolls(); // update vote counts
      renderPollList();
      renderMyVotes();
      showNotification('Vote recorded');
    } else {
      const err = await res.json().catch(()=>({detail:'vote failed'}));
      alert(err.detail || JSON.stringify(err));
    }
  } catch(e){
    console.error(e);
    alert('Vote error');
  } finally{
    if(btnRef) btnRef.disabled = false;
  }
}

/* ======= My Votes ======= */
async function loadMyVotes(){
  try{
    const res = await fetch(`${API_BASE}/my-votes/`, { headers: authHeaders() });
    if(!res.ok){ myVotes = []; return; }
    myVotes = await res.json();
    // normalize some fields for template usage
    myVotes = myVotes.map(v=>{
      return Object.assign({
        poll_title: v.poll_title || v.poll || 'Untitled',
        question_text: v.question_text || v.question || '',
        choice_text: v.choice_text || v.choice || '',
        voted_at: v.voted_at || v.timestamp || v.created_at || null,
        choice_id: v.choice || v.choice_id || null
      }, v);
    });
  } catch(e){
    console.error(e);
    myVotes = [];
  }
}

function renderMyVotes(){
  const out = document.getElementById('my-votes-list');
  out.innerHTML = '';
  if(!myVotes || myVotes.length===0){
    out.innerHTML = `<div class="empty">You haven't voted yet. Go to Active Polls to cast your vote.</div>`;
    return;
  }

  // group by poll
  const byPoll = {};
  myVotes.forEach(v=>{
    const pt = v.poll_title || 'Poll';
    if(!byPoll[pt]) byPoll[pt] = [];
    byPoll[pt].push(v);
  });

  Object.keys(byPoll).forEach(pt=>{
    const pollSection = document.createElement('div');
    pollSection.className = 'poll-card';
    pollSection.innerHTML = `<h4>${escapeHtml(pt)}</h4>`;
    byPoll[pt].forEach(v=>{
      const card = document.createElement('div');
      card.className = 'vote-card';
      card.innerHTML = `
        <div style="font-weight:600">${escapeHtml(v.question_text || '')}</div>
        <div style="margin-top:6px">${escapeHtml(v.choice_text || '')}</div>
        <div class="vote-meta"><div class="small muted">${v.user || ''}</div><div class="small muted">${formatDate(v.voted_at)}</div></div>
      `;
      pollSection.appendChild(card);
    });
    out.appendChild(pollSection);
  });

}

/* ======= Admin: load poll list into select and show results ======= */
async function populateAdminPollSelect(){
  const sel = document.getElementById('admin-poll-select');
  sel.innerHTML = '<option value="">Loading polls...</option>';
  try{
    const res = await fetch(`${API_BASE}/polls/`, { headers: authHeaders() });
    if(!res.ok){ sel.innerHTML = '<option value="">No polls</option>'; return; }
    const polls = await res.json();
    // store locally
    allPolls = polls;
    sel.innerHTML = '<option value="">-- choose poll --</option>';
    polls.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.innerText = p.title || `Poll ${p.id}`;
      sel.appendChild(opt);
    });
  } catch(e){
    console.error(e);
    sel.innerHTML = '<option value="">Error loading</option>';
  }
}

async function adminLoadSelectedPollResults(){
  const sel = document.getElementById('admin-poll-select');
  const pollId = sel.value;
  if(!pollId) return;

  await adminLoadPollResults(pollId);
}

async function adminLoadPollResults(pollId){
  try{
    const res = await fetch(`${API_BASE}/polls/${pollId}/results/`, { headers: authHeaders() });
    if(!res.ok){
      const txt = await res.text();
      document.getElementById('admin-results-list').innerHTML = `<div class="muted">Unable to load results: ${txt}</div>`;
      return;
    }
    const data = await res.json(); // expected [{ choice__text, total }, ...]
    // prepare chart
    const labels = data.map(d => d.choice__text || d.choice_text || 'Choice');
    const counts = data.map(d => d.total || 0);

    const ctx = document.getElementById('adminChart').getContext('2d');
    if(adminChart) adminChart.destroy();
    adminChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: counts,
          // Chart.js will auto-assign colors if not provided; that's fine
          backgroundColor: undefined
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.formattedValue} votes` } }
        }
      }
    });

    // numeric results
    const numeric = document.getElementById('admin-results-list');
    numeric.innerHTML = '';
    data.forEach(d=>{
      const r = document.createElement('div');
      r.style.padding = '8px';
      r.style.borderBottom = '1px dashed #eef6fb';
      r.innerHTML = `<div style="display:flex;justify-content:space-between;gap:12px">
                      <div style="font-weight:600">${escapeHtml(d.choice__text || d.choice_text || 'Choice')}</div>
                      <div class="small muted">${d.total} votes</div>
                    </div>`;
      numeric.appendChild(r);
    });

  } catch(e){
    console.error(e);
    document.getElementById('admin-results-list').innerHTML = `<div class="muted">Error loading results</div>`;
  }
}

async function adminRefresh(){
  const sel = document.getElementById('admin-poll-select');
  const pollId = sel.value;
  if(!pollId) {
    await populateAdminPollSelect();
    return;
  }
  await adminLoadPollResults(pollId);
}

/* ======= Admin Export CSV ======= */
async function adminExportCSV() {
  const sel = document.getElementById('admin-poll-select');
  const pollId = sel.value;
  if(!pollId) {
    alert('Please select a poll first');
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/polls/${pollId}/export/`, { 
      headers: authHeaders() 
    });
    
    if(!res.ok) {
      alert('Export failed: ' + await res.text());
      return;
    }
    
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `poll-${pollId}-results.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    showNotification('CSV exported successfully');
  } catch(e) {
    console.error(e);
    alert('Export error: ' + e.message);
  }
}

/* ======= Admin Show Results ======= */
async function adminShowResults() {
  const sel = document.getElementById('admin-poll-select');
  const pollId = sel.value;
  if(!pollId) {
    alert('Please select a poll first');
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/polls/${pollId}/results/`, { 
      headers: authHeaders() 
    });
    
    if(!res.ok) {
      alert('Failed to load results: ' + await res.text());
      return;
    }
    
    const results = await res.json();
    
    // Display results in a formatted way
    const resultsContainer = document.getElementById('admin-results-list');
    resultsContainer.innerHTML = '';
    
    results.forEach(result => {
      const resultCard = document.createElement('div');
      resultCard.className = 'results-card';
      resultCard.innerHTML = `
        <div class="results-header">
          <strong>${escapeHtml(result.choice__text || result.choice_text || 'Choice')}</strong>
          <span class="vote-badge">${result.total} votes</span>
        </div>
        <div class="results-stats">
          <span>Percentage: ${Math.round((result.total / results.reduce((sum, r) => sum + r.total, 0)) * 100)}%</span>
        </div>
      `;
      resultsContainer.appendChild(resultCard);
    });
    
    showNotification('Results loaded successfully');
  } catch(e) {
    console.error(e);
    alert('Error loading results: ' + e.message);
  }
}

/* ======= Utility & small UX ======= */
function showNotification(text){
  const n = document.createElement('div');
  n.innerText = text;
  n.style.position = 'fixed';
  n.style.right = '18px';
  n.style.bottom = '18px';
  n.style.background = 'linear-gradient(90deg,var(--primary),var(--accent))';
  n.style.color='white';
  n.style.padding = '10px 14px';
  n.style.borderRadius = '8px';
  n.style.boxShadow = '0 8px 24px rgba(12,34,80,0.12)';
  n.style.zIndex = 9999;
  document.body.appendChild(n);
  setTimeout(()=>n.remove(), 3000);
}

function formatDate(s){
  if(!s) return '';
  try{
    const d = new Date(s);
    return d.toLocaleString();
  } catch(e){ return s; }
}

function escapeHtml(str){
  if(!str) return '';
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'", '&#39;');
}

/* ======= Auto-init if token present ======= */
(async function init(){
  if(token){
    try{
      await initializeAfterLogin();
      showTab('polls');
    } catch(e){
      console.warn('Auto-init failed', e);
      // clear invalid token
      localStorage.removeItem('token');
      token = null;
    }
  } else {
    // not logged in: show login form
    document.getElementById('auth-forms').style.display = 'block';
    document.getElementById('user-box').style.display = 'none';
    setStatus('Not signed in');
  }
})();
</script>
</body>
</html>